# GEL3 Website Nginx config
# This needs to be deploy manually to nginx if change are made
# See DEPLOY.md in https://github.com/WestpacGEL/GEL


# settings
#
server_tokens  off;

# prevent click jacking attacks
add_header  X-Frame-Options SAMEORIGIN;

# disallow circumventing declared MIME types
# add_header  X-Content-Type-Options nosniff;

# X-XSS-Protection
add_header  X-XSS-Protection '1; mode=block';

# HSTS (ngx_http_headers_module is required) (15768000 seconds = 6 months)
add_header  Strict-Transport-Security 'max-age=31536000; includeSubDomains;' always;

# Content Security Policy
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' data: https://ssl.google-analytics.com https://cdn.polyfill.io https://www.gstatic.com https://gateway.zscloud.net; img-src 'self' data: https://ssl.google-analytics.com https://res.cloudinary.com/; connect-src 'self' https://ssl.google-analytics.com; style-src 'self' 'unsafe-inline' https://www.gstatic.com; font-src 'self' data: https://fonts.gstatic.com; frame-src 'self' https://www.youtube.com https://player.vimeo.com https://gateway.zscloud.net; object-src 'none'";

# CORS
add_header  'Access-Control-Allow-Origin' '*';
add_header  'Access-Control-Allow-Credentials' 'true';
add_header  'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
add_header  'Access-Control-Allow-Headers' 'DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type';


# http to https redirect
#
server {
	listen       80;
	server_name  gel.dev.westpac.local;
	return 301   https://$host$request_uri;
}

# ssl and http2 config
#
server {
	listen       443 ssl http2;
	listen       [::]:443 ssl http2;
	server_name  gel.dev.westpac.local;
	root         /var/www/html/;

	ssl_certificate      certs/gel.dev.westpac.local-cert.pem;
	ssl_certificate_key  certs/gel.dev.westpac.local-privkey.pem;

	ssl_session_timeout  1d;
	ssl_session_cache    shared:SSL:50m;
	ssl_session_tickets  off;

	ssl_protocols              TLSv1 TLSv1.1 TLSv1.2;
	ssl_prefer_server_ciphers  on;
	ssl_dhparam                dhparam-2048.pem;
	ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256';


	# Keystone GEL3 website routes
	# -----------------------------------------

	proxy_connect_timeout   5;
	proxy_read_timeout      30;

	# Website: /design-system > localhost:3000/design-system
	location /design-system {
		root   /var/www/html/;
		proxy_pass              http://localhost:3000/design-system;
		proxy_redirect          http://localhost:3000/design-system  /design-system;

		proxy_set_header X-Real-IP         $remote_addr;
		proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_set_header X-Forwarded-Host  $host;
		proxy_set_header X-Forwarded-Port  $server_port;
	}
	location /_next {
		root   /var/www/html/;
		proxy_pass              http://localhost:3000/_next;
		proxy_redirect          http://localhost:3000/_next  /_next;

		proxy_set_header X-Real-IP         $remote_addr;
		proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_set_header X-Forwarded-Host  $host;
		proxy_set_header X-Forwarded-Port  $server_port;
	}

	# CMS: /admin > localhost:3000/admin
	location /admin {
		root   /var/www/html/;
		proxy_pass              http://localhost:3000/admin;
		proxy_redirect          http://localhost:3000/admin  /admin;

		proxy_set_header X-Real-IP         $remote_addr;
		proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_set_header X-Forwarded-Host  $host;
		proxy_set_header X-Forwarded-Port  $server_port;
	}

	# GraphQL: /graphql > localhost:3000/admin/api
	location /graphql {
		root   /var/www/html/;
		proxy_pass              http://localhost:3000/admin/api;
		proxy_redirect          http://localhost:3000/admin/api  /graphql;

		proxy_set_header X-Real-IP         $remote_addr;
		proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_set_header X-Forwarded-Host  $host;
		proxy_set_header X-Forwarded-Port  $server_port;
	}

}
